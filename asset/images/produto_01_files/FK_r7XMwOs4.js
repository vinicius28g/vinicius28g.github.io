;/*FB_PKG_DELIM*/

__d("MAWDataSourceLogger",["I64","MAWQPLLogger","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){i==null&&(i=c("MAWQPLLogger")(c("qpl")._(25303796,"1974")));return i}function a(){return j().markQPLStart()}function b(a,b,c){j().markQPLPoint(a,"wait_act_thread_start","before fetching messages range from table"),j().addQPLAnnotations(a,{"int":{version:1},string:{direction:b,thread_id:(h||(h=d("I64"))).to_string(c)}})}function e(a,b){j().markQPLFailureWithMsg(a,b)}function f(a){j().markQPLCancel(a)}function k(a){j().markQPLPoint(a,"wait_act_thread_end","before fetching messages range from table"),j().markQPLPoint(a,"load_more_msgs_start","load more messages from MAW DB")}function l(a,b){j().markQPLPoint(a,"load_more_msgs_end","Note: OLD SOLUTION DOES NOT FETCH messages. they are fetched in afterTransaction that we cannot control"),j().addQPLAnnotations(a,{bool:{hasMoreBefore:b}})}function m(a){j().markQPLSuccess(a)}function n(a,b){j().markQPLPoint(a,"issued_range_query","MAWFetchSecureMessages: minMsgSortOrderTsResponse "+b)}function o(a,b){j().markQPLFailure(a,b)}g.logLoadMoreMsgsStart=a;g.logLoadMoreMsgsThreadWaiting=b;g.logLoadMoreMsgsFailure=e;g.logLoadMoreMsgsCancel=f;g.logLoadMoreMsgsThreadReadyFetchMsgs=k;g.logLoadMoreMsgsFetched=l;g.logLoadMoreMsgsSuccess=m;g.logLoadMoreMsgsRangeQuery=n;g.logLoadMoreMsgsRuntimeError=o}),98);
__d("MAWSecureDataSource",[],(function(a,b,c,d,e,f){"use strict";a=10;f.DEFAULT_NUM_MESSAGES=a}),66);
__d("MAWDeprecatedDataSource",["I64","MAWBridgeSendAndReceive","MAWDataSourceLogger","MAWDbMsg","MAWMiActOnActThreadReady","MAWSecureDataSource","MWEncryptedBackupsIssueRangeQueryDeferred","Promise","ReQL","WATagsLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["useFetchSecureMessages: threadJid: "," threadId: "," minMsgSortOrderTsResponse ",""]);j=function(){return a};return a}a=function(){function a(){}var c=a.prototype;c.$1=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f){d("MAWDataSourceLogger").logLoadMoreMsgsThreadWaiting(f,"after",b);var g=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.messages_ranges_v2__generated).getKeyRange(b)));if(g==null){d("MAWDataSourceLogger").logLoadMoreMsgsFailure(f,"no-message-range");return}if(g.isLoadingBefore){d("MAWDataSourceLogger").logLoadMoreMsgsCancel(f);return}if(c!=="before"){d("MAWDataSourceLogger").logLoadMoreMsgsFailure(f,"only-before-direction-is-supported");return}c=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,b,"MAWFetchMoreMessages"));b=c.chatId;c=c.chatJid;d("MAWDataSourceLogger").logLoadMoreMsgsThreadReadyFetchMsgs(f);g=d("MAWDbMsg").toMsgId(g.minMessageId);var h=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","loadMoreMsgs",{chatJid:c,direction:"before",numMsgs:e,offsetMsgId:g,threadId:b}));d("MAWDataSourceLogger").logLoadMoreMsgsFetched(f,h.hasMoreBefore);if(h.hasMoreBefore){d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(f);return}h=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getMaybeNextNonAdminMsgSortOrderMs",{mayBeAdminMsgId:g,threadId:b}));d("WATagsLogger").TAGS(["labyrinth_web","useFetchSecureMessages"]).LOG(j(),c,b,h.minMsgTimestampMs);d("MAWDataSourceLogger").logLoadMoreMsgsRangeQuery(f,h.minMsgTimestampMs);yield d("MWEncryptedBackupsIssueRangeQueryDeferred").issueRangeQueryDeferred({db:a,newerNumMessages:(i||(i=d("I64"))).zero,numMessages:i.of_int32(e),sortOrderMs:i.of_float(h.minMsgTimestampMs),threadId:b});d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(f)});function c(b,c,d,e,f){return a.apply(this,arguments)}return c}();c.requestMessages=function(a,c,d,e,f,g,i,j){return(h||(h=b("Promise"))).reject("MAWDeprecatedDataSource does not support request-response model")};c.fetchSecureMessagesProtocol=function(a,b,c,e,f,g){g===void 0&&(g=d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES);var h=d("MAWDataSourceLogger").logLoadMoreMsgsStart();return this.$1(a,b,f,g,h)["catch"](function(a){d("MAWDataSourceLogger").logLoadMoreMsgsRuntimeError(h,a)})};return a}();g["default"]=a}),98);